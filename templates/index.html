<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Generator</title>
    <link href="https://unpkg.com/@primer/css@^20.2.4/dist/primer.css" rel="stylesheet" />
</head>
<body class="color-bg-default">
    <div class="container-fluid p-responsive py-3">
        <h1 class="h1 text-center color-fg-default mb-3" style="font-size: 2rem;">RSS Generator</h1>
        
        <div class="d-flex" style="gap: 2rem; height: calc(100vh - 100px);">
            <!-- Left Panel: Input Form -->
            <div class="Box color-shadow-large" style="flex: 1; display: flex; flex-direction: column;">
                <div class="Box-header">
                    <h2 class="Box-title text-center" style="font-size: 1.8rem;">Configuration</h2>
                </div>
                <form id="rssForm" class="Box-body" style="flex: 1; overflow-y: auto;">
                    <!-- Step 1: URL Input -->
                    <div class="form-group mb-4">
                        <div class="form-group-header">
                            <h3 class="h4 color-fg-default" style="font-size: 1.5rem;">1. Enter Website URL</h3>
                        </div>
                        <div class="form-group-body">
                            <input type="url" id="url" required 
                                   class="form-control width-full"
                                   style="font-size: 1.2rem; padding: 0.75rem;"
                                   placeholder="https://example.com/blog">
                            <p class="note" style="font-size: 1rem; margin-top: 0.5rem;">Enter the URL of the website you want to create an RSS feed for</p>
                        </div>
                    </div>

                    <!-- Step 2: Selector Configuration -->
                    <div class="form-group mb-4">
                        <div class="form-group-header">
                            <h3 class="h4 color-fg-default" style="font-size: 1.5rem;">2. Configure Selectors</h3>
                        </div>
                        <div class="form-group-body">
                            <div class="mb-3">
                                <label class="form-label" style="font-size: 1.2rem;">Title Selector (XPath)</label>
                                <input type="text" id="titleSelector" required 
                                       class="form-control"
                                       style="font-size: 1.2rem; padding: 0.75rem;"
                                       placeholder="">
                            </div>
                            <div>
                                <label class="form-label" style="font-size: 1.2rem;">Description Selector (XPath)</label>
                                <input type="text" id="descriptionSelector" required 
                                       class="form-control"
                                       style="font-size: 1.2rem; padding: 0.75rem;"
                                       placeholder="">
                            </div>
                        </div>
                    </div>

                    <div class="d-flex flex-column gap-2">
                        <div class="BtnGroup d-flex">
                            <button type="submit" id="generateButton" class="btn btn-primary flex-1 BtnGroup-item" 
                                    style="font-size: 1.3rem; padding: 1rem; height: auto;"
                                    disabled>
                                <span id="generateButtonText">Generate Preview</span>
                                <span id="generateButtonLoading" style="display: none;">
                                    <span class="AnimatedEllipsis"></span>
                                    Generating...
                                </span>
                            </button>
                            <button type="button" id="saveButton" onclick="saveFeed()" 
                                    class="btn btn-outline flex-1 BtnGroup-item" 
                                    style="font-size: 1.3rem; padding: 1rem; height: auto;"
                                    disabled>
                                <span id="saveButtonText">Create RSS Link</span>
                                <span id="saveButtonLoading" style="display: none;">
                                    <span class="AnimatedEllipsis"></span>
                                    Creating...
                                </span>
                            </button>
                        </div>
                        
                        <!-- Move the saved feed container here, after the buttons -->
                        <div id="savedFeedContainer" class="mt-3" style="display: none;">
                            <div class="flash flash-success">
                                <p class="mb-1">Feed saved successfully!</p>
                                <div class="d-flex">
                                    <input type="text" id="savedFeedUrl" readonly class="form-control flex-1" />
                                    <button type="button" onclick="copySavedUrl(event)" class="btn ml-2">Copy URL</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Middle Panel: XPath Selector List -->
            <div class="Box color-shadow-large" style="flex: 1; display: flex; flex-direction: column;">
                <div class="Box-header">
                    <h2 class="Box-title text-center" style="font-size: 1.8rem;">Available Selectors</h2>
                </div>
                <div class="Box-body" style="flex: 1; overflow-y: auto;">
                    <div id="selectorList" class="Box">
                        <div class="blankslate">
                            <h3 class="blankslate-heading">Enter a URL</h3>
                            <p class="blankslate-text">Available selectors will appear here after you enter a URL.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Preview -->
            <div class="Box color-shadow-large" style="flex: 1; display: flex; flex-direction: column;">
                <div class="Box-header">
                    <h2 class="Box-title text-center" style="font-size: 1.8rem;">Preview</h2>
                </div>
                <div id="result" class="Box-body" style="flex: 1; overflow-y: auto;">
                    <div id="feedPreview" class="Box p-3 color-bg-subtle">
                        <div class="blankslate">
                            <h3 class="blankslate-heading">No RSS Feed Generated Yet</h3>
                            <p class="blankslate-text">Configure the selectors and click Generate Preview to see the preview here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function copyRssUrl() {
            const currentUrl = window.location.href;
            const url = document.getElementById('url').value;
            const titleSelector = document.getElementById('titleSelector').value;
            const descriptionSelector = document.getElementById('descriptionSelector').value;
            
            const rssUrl = `${currentUrl}generate_rss?url=${encodeURIComponent(url)}&title_selector=${encodeURIComponent(titleSelector)}&description_selector=${encodeURIComponent(descriptionSelector)}`;
            
            navigator.clipboard.writeText(rssUrl)
                .then(() => alert('RSS URL copied to clipboard!'))
                .catch(err => alert('Failed to copy URL: ' + err));
        }

        function parseXMLtoHTML(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");
            let html = '';

            for (let item of items) {
                const title = item.getElementsByTagName("title")[0]?.textContent || 'No title';
                const link = item.getElementsByTagName("link")[0]?.textContent || '#';
                const description = item.getElementsByTagName("description")[0]?.textContent || 'No description';

                html += `
                    <div class="border-bottom color-border-muted py-3 last:border-bottom-0">
                        <h4 class="h5 color-fg-default mb-1">
                            <a href="${link}" target="_blank" class="color-fg-accent">
                                ${title}
                            </a>
                        </h4>
                        <p class="color-fg-muted mb-0">${description}</p>
                    </div>
                `;
            }

            return html || '<div class="color-fg-muted">No items found in feed</div>';
        }

        // Replace the CSS selector validation with XPath validation
        function isValidXPathSelector(selector) {
            try {
                document.evaluate(selector, document, null, XPathResult.ANY_TYPE, null);
                return true;
            } catch (e) {
                return false;
            }
        }

        function validateForm() {
            const url = document.getElementById('url').value;
            const titleSelector = document.getElementById('titleSelector').value;
            const descriptionSelector = document.getElementById('descriptionSelector').value;
            
            const isValid = url && 
                           titleSelector && 
                           descriptionSelector && 
                           isValidXPathSelector(titleSelector) && 
                           isValidXPathSelector(descriptionSelector);
            
            // Only enable the Generate Preview button based on form validation
            document.getElementById('generateButton').disabled = !isValid;
            // Always keep Create RSS Link button disabled until preview is generated
            document.getElementById('saveButton').disabled = true;
        }

        // Update existing input event listeners
        document.getElementById('url').addEventListener('input', validateForm);
        document.getElementById('titleSelector').addEventListener('input', function(e) {
            const input = e.target;
            const selector = input.value;
            
            if (selector && !isValidXPathSelector(selector)) {
                input.setCustomValidity('Invalid XPath selector');
                input.classList.add('border-red-500');
                
                let errorMsg = input.parentNode.querySelector('.error-message');
                if (!errorMsg) {
                    errorMsg = document.createElement('p');
                    errorMsg.className = 'error-message text-red-500 text-sm mt-1';
                    input.parentNode.appendChild(errorMsg);
                }
                errorMsg.textContent = 'Please enter a valid XPath selector';
            } else {
                input.setCustomValidity('');
                input.classList.remove('border-red-500');
                
                const errorMsg = input.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
            validateForm();
        });

        document.getElementById('descriptionSelector').addEventListener('input', function(e) {
            const input = e.target;
            const selector = input.value;
            
            if (selector && !isValidXPathSelector(selector)) {
                input.setCustomValidity('Invalid XPath selector');
                input.classList.add('border-red-500');
                
                let errorMsg = input.parentNode.querySelector('.error-message');
                if (!errorMsg) {
                    errorMsg = document.createElement('p');
                    errorMsg.className = 'error-message text-red-500 text-sm mt-1';
                    input.parentNode.appendChild(errorMsg);
                }
                errorMsg.textContent = 'Please enter a valid XPath selector';
            } else {
                input.setCustomValidity('');
                input.classList.remove('border-red-500');
                
                const errorMsg = input.parentNode.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.remove();
                }
            }
            validateForm();
        });

        // Add helper functions for button states
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const textSpan = document.getElementById(`${buttonId}Text`);
            const loadingSpan = document.getElementById(`${buttonId}Loading`);
            
            button.disabled = isLoading;
            textSpan.style.display = isLoading ? 'none' : 'inline';
            loadingSpan.style.display = isLoading ? 'inline' : 'none';
        }

        // Update form submission handler
        document.getElementById('rssForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            setButtonLoading('generateButton', true);
            
            const data = {
                url: document.getElementById('url').value,
                title_selector: document.getElementById('titleSelector').value,
                description_selector: document.getElementById('descriptionSelector').value
            };
            
            try {
                const response = await fetch('/generate_rss', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const resultDiv = document.getElementById('result');
                resultDiv.classList.remove('hidden');
                
                const feedPreview = document.getElementById('feedPreview');
                feedPreview.innerHTML = parseXMLtoHTML(result.rss_content);
                
                // Enable save button after successful preview
                document.getElementById('saveButton').disabled = false;
                
            } catch (error) {
                alert('Error generating RSS feed: ' + error.message);
                document.getElementById('saveButton').disabled = true;
            } finally {
                // Reset loading state
                setButtonLoading('generateButton', false);
            }
        });

        let allSelectors = [];

        function togglePanel() {
            const panel = document.getElementById('selectorPanel');
            panel.classList.toggle('translate-x-full');
        }

        async function fetchSelectors(url) {
            try {
                const response = await fetch('/get_selectors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                allSelectors = data.selectors;
                displaySelectors(allSelectors);
                
            } catch (error) {
                console.error('Error fetching selectors:', error);
            }
        }

        function displaySelectors(selectors) {
            const container = document.getElementById('selectorList');
            container.innerHTML = selectors.map(selector => `
                <div class="Box-row">
                    <div class="d-flex flex-justify-between mb-2">
                        <code class="color-fg-accent">${selector.css}</code>
                        <span class="Label">${selector.example} matches</span>
                    </div>
                    
                    <div class="color-fg-muted f6 mb-2">
                        <code>${selector.xpath}</code>
                    </div>
                    
                    <div class="color-bg-subtle p-2 mb-2 rounded-2">
                        <ul class="list-style-none" style="margin-bottom: 0;">
                            ${selector.samples.map(sample => `
                                <li class="f6 color-fg-muted mb-1">
                                    <span class="text-bold mr-2">â€¢</span>${sample}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2">
                        <button onclick="useSelector('${selector.css}', 'title')" 
                                class="btn btn-sm btn-success">Use as Title</button>
                        <button onclick="useSelector('${selector.css}', 'description')" 
                                class="btn btn-sm btn-outline">Use as Description</button>
                    </div>
                </div>
            `).join('');
        }

        // Update the useSelector function to use XPath
        function useSelector(selector, type) {
            const input = document.getElementById(type === 'title' ? 'titleSelector' : 'descriptionSelector');
            // Convert CSS selector to XPath using the server response
            const selectorData = allSelectors.find(s => s.css === selector);
            if (selectorData) {
                input.value = selectorData.xpath;
                input.dispatchEvent(new Event('input'));
            }
        }

        // Update the URL input handler to fetch selectors
        document.getElementById('url').addEventListener('change', (e) => {
            const url = e.target.value;
            if (url) {
                fetchSelectors(url);
            }
        });

        // Add preview functionality
        function previewSelector(selector) {
            // Remove any existing highlights
            document.querySelectorAll('.selector-highlight').forEach(el => {
                el.classList.remove('selector-highlight');
            });
            
            // Add highlight class to matching elements
            try {
                document.querySelectorAll(selector).forEach(el => {
                    el.classList.add('selector-highlight');
                    
                    // Scroll first element into view
                    if (el === document.querySelector(selector)) {
                        el.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                });
                
                // Remove highlights after 2 seconds
                setTimeout(() => {
                    document.querySelectorAll('.selector-highlight').forEach(el => {
                        el.classList.remove('selector-highlight');
                    });
                }, 2000);
            } catch (e) {
                console.error('Invalid selector:', e);
            }
        }

        // Add CSS for highlighting
        const style = document.createElement('style');
        style.textContent = `
            .selector-highlight {
                outline: 3px solid #4f46e5 !important; /* indigo-600 */
                background-color: rgba(79, 70, 229, 0.1) !important;
                transition: all 0.3s ease-in-out !important;
            }
        `;
        document.head.appendChild(style);

        // Update save feed function
        async function saveFeed() {
            setButtonLoading('saveButton', true);
            
            const data = {
                url: document.getElementById('url').value,
                title_selector: document.getElementById('titleSelector').value,
                description_selector: document.getElementById('descriptionSelector').value
            };
            
            try {
                const response = await fetch('/save_feed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const container = document.getElementById('savedFeedContainer');
                const urlInput = document.getElementById('savedFeedUrl');
                container.style.display = 'block';
                urlInput.value = result.rss_url;
                
            } catch (error) {
                alert('Error saving feed: ' + error.message);
            } finally {
                setButtonLoading('saveButton', false);
            }
        }

        function copySavedUrl(event) {
            event.preventDefault();  // Prevent any form submission
            event.stopPropagation();  // Stop event bubbling
            
            const urlInput = document.getElementById('savedFeedUrl');
            urlInput.select();
            document.execCommand('copy');
            
            // Simple success feedback
            const copyBtn = event.target;
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = 'Copy URL';
            }, 2000);
        }
    </script>

    <style>
        /* Add loading animation styles */
        .AnimatedEllipsis {
            display: inline-block;
            animation: ellipsis 1.5s infinite;
            margin-right: 4px;
        }

        @keyframes ellipsis {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }
    </style>
</body>
</html>
