<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-[1920px] mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">RSS Generator</h1>
        
        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Form -->
            <div class="bg-white rounded-lg shadow p-6 max-w-xl mx-auto lg:mx-0 w-full">
                <form id="rssForm">
                    <!-- URL Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Website URL</label>
                        <input type="url" id="url" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="https://example.com">
                    </div>

                    <!-- Selectors -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title XPath</label>
                            <input type="text" id="titleSelector" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description XPath</label>
                            <input type="text" id="descriptionSelector" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="mt-6 space-y-3">
                        <button type="submit" id="generateButton" 
                                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                                disabled>
                            Generate Preview
                        </button>
                        <button type="button" id="saveButton" onclick="saveFeed()" 
                                class="w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                                disabled>
                            Create RSS Link
                        </button>
                    </div>

                    <!-- Success Message -->
                    <div id="savedFeedContainer" class="hidden mt-4">
                        <div class="bg-green-50 border border-green-200 rounded-md p-4">
                            <p class="text-green-700 mb-2">Feed saved successfully!</p>
                            <div class="flex gap-2">
                                <input type="text" id="savedFeedUrl" readonly 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                                <button type="button" onclick="copySavedUrl(event)"
                                        class="px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                    Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Selector List -->
            <div class="bg-white rounded-lg shadow p-6 flex flex-col h-[700px]">
                <h2 class="text-xl font-semibold mb-4">Available Selectors</h2>
                <div id="selectorList" class="space-y-4 overflow-y-auto flex-1 pr-2">
                    <div class="text-center text-gray-500">
                        Enter a URL to see available selectors
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="bg-white rounded-lg shadow p-6 flex flex-col h-[700px]">
                <h2 class="text-xl font-semibold mb-4">Preview</h2>
                <div id="feedPreview" class="space-y-4 overflow-y-auto flex-1 pr-2">
                    <div class="text-center text-gray-500">
                        Configure selectors and generate preview to see results
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keep existing JavaScript but remove style tag -->
    <script>
    document.getElementById('url').addEventListener('input', debounce(async function(e) {
        const url = e.target.value;
        if (!url) return;

        const selectorList = document.getElementById('selectorList');
        
        // Show loading state
        selectorList.innerHTML = `
            <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">Analyzing page structure...</span>
            </div>
        `;

        try {
            const response = await fetch('/get_selectors', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url })
            });

            const data = await response.json();
            console.log('Selector Response:', data);

            if (data.error) {
                selectorList.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-600 font-medium">${data.error}</p>
                        ${data.details ? 
                            `<ul class="list-disc pl-5 mt-2 text-sm text-red-500">
                                ${data.details.map(d => `<li>${d}</li>`).join('')}
                            </ul>` 
                            : ''
                        }
                    </div>
                `;
                return;
            }

            selectorList.innerHTML = data.selectors.map(selector => {
                // Escape the XPath string for safe usage in HTML attributes
                const escapedXPath = selector.xpath.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <button onclick="useSelector(\`${escapedXPath}\`)" 
                                    class="text-blue-600 hover:text-blue-800 font-medium truncate max-w-[80%] text-left">
                                ${selector.css}
                            </button>
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                ${selector.example} matches
                            </span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p class="font-medium mb-1">Examples:</p>
                            <ul class="space-y-2">
                                ${selector.samples.map(sample => `
                                    <li class="bg-gray-50 p-2 rounded border border-gray-100 hover:border-gray-200 transition-colors">
                                        ${sample}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button onclick="useSelector(\`${escapedXPath}\`)" 
                                    class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full hover:bg-blue-100 transition-colors">
                                Use as Title
                            </button>
                            <button onclick="useAsDescription(\`${escapedXPath}\`)" 
                                    class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full hover:bg-green-100 transition-colors">
                                Use as Description
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (error) {
            console.error('Error fetching selectors:', error);
            selectorList.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-600 font-medium">Error fetching selectors</p>
                    <p class="text-sm text-red-500 mt-1">Please try again or check the console for details.</p>
                </div>
            `;
        }
    }, 500));

    // Debounce function to prevent too many requests
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function useSelector(xpath) {
        document.getElementById('titleSelector').value = xpath;
        document.getElementById('generateButton').disabled = 
            !document.getElementById('titleSelector').value || 
            !document.getElementById('descriptionSelector').value;
    }

    function useAsDescription(xpath) {
        document.getElementById('descriptionSelector').value = xpath;
        document.getElementById('generateButton').disabled = 
            !document.getElementById('titleSelector').value || 
            !document.getElementById('descriptionSelector').value;
    }

    // Add custom scrollbar styles
    const style = document.createElement('style');
    style.textContent = `
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #CBD5E1 transparent;
        }
        
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #CBD5E1;
            border-radius: 3px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background-color: #94A3B8;
        }

        /* Add smooth scrolling to both containers */
        #selectorList, #feedPreview {
            scroll-behavior: smooth;
        }
    `;
    document.head.appendChild(style);

    // Handle form submission for preview generation
    document.getElementById('rssForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const url = document.getElementById('url').value;
        const titleSelector = document.getElementById('titleSelector').value;
        const descriptionSelector = document.getElementById('descriptionSelector').value;
        const previewContainer = document.getElementById('feedPreview');
        const generateButton = document.getElementById('generateButton');
        const saveButton = document.getElementById('saveButton');
        
        // Show loading state
        generateButton.disabled = true;
        previewContainer.innerHTML = `
            <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">Generating preview...</span>
            </div>
        `;

        try {
            const response = await fetch('/generate_rss', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url,
                    title_selector: titleSelector,
                    description_selector: descriptionSelector
                })
            });

            const data = await response.json();

            if (data.error) {
                previewContainer.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-600 font-medium">Error generating preview</p>
                        <p class="text-sm text-red-500 mt-1">${data.error}</p>
                    </div>
                `;
                return;
            }

            // Parse the RSS content to display it nicely
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(data.rss_content, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");

            let previewHtml = `
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-blue-800 font-medium">Preview of first ${Math.min(3, items.length)} items</p>
                    </div>
            `;

            // Display first 3 items
            for (let i = 0; i < Math.min(3, items.length); i++) {
                const item = items[i];
                const title = item.getElementsByTagName("title")[0]?.textContent || 'No title';
                const description = item.getElementsByTagName("description")[0]?.textContent || 'No description';
                const link = item.getElementsByTagName("link")[0]?.textContent || '#';

                previewHtml += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <h3 class="font-medium text-lg mb-2">
                            <a href="${link}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                ${title}
                            </a>
                        </h3>
                        <p class="text-gray-600 text-sm">${description}</p>
                    </div>
                `;
            }

            previewHtml += '</div>';
            previewContainer.innerHTML = previewHtml;
            
            // Enable save button after successful preview
            saveButton.disabled = false;

        } catch (error) {
            console.error('Error generating preview:', error);
            previewContainer.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-600 font-medium">Error generating preview</p>
                    <p class="text-sm text-red-500 mt-1">Please try again or check the console for details.</p>
                </div>
            `;
        } finally {
            generateButton.disabled = false;
        }
    });

    // Add save feed functionality
    async function saveFeed() {
        const url = document.getElementById('url').value;
        const titleSelector = document.getElementById('titleSelector').value;
        const descriptionSelector = document.getElementById('descriptionSelector').value;
        const saveButton = document.getElementById('saveButton');
        const savedFeedContainer = document.getElementById('savedFeedContainer');
        
        saveButton.disabled = true;
        
        try {
            const response = await fetch('/save_feed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url,
                    title_selector: titleSelector,
                    description_selector: descriptionSelector
                })
            });

            const data = await response.json();

            if (data.error) {
                alert('Error saving feed: ' + data.error);
                return;
            }

            // Show success message and RSS URL
            savedFeedContainer.classList.remove('hidden');
            document.getElementById('savedFeedUrl').value = data.rss_url;

        } catch (error) {
            console.error('Error saving feed:', error);
            alert('Error saving feed. Please try again.');
        } finally {
            saveButton.disabled = false;
        }
    }

    // Add copy URL functionality
    function copySavedUrl(event) {
        const urlInput = document.getElementById('savedFeedUrl');
        urlInput.select();
        document.execCommand('copy');
        
        // Show feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    }
    </script>
</body>
</html>
